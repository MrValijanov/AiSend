<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AiSend Â· Demo</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg-main: #020a05;
      --bg-card: #03240d;
      --bg-card-soft: #063016;
      --bg-chip: #0a3e1f;
      --accent: #4dff4d;
      --accent-soft: rgba(77, 255, 77, 0.14);
      --accent-strong: #9bff4d;
      --danger: #ff3b30;
      --text-main: #ffffff;
      --text-soft: #c3e4c9;
      --border-soft: rgba(255, 255, 255, 0.08);
      --shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.85);
      --radius-xl: 32px;
      --radius-lg: 24px;
      --radius-md: 16px;
      --radius-pill: 999px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #05401c 0, #020a05 55%);
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
    }

    #app {
      min-height: 100vh;
      padding: 16px 16px 28px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* Header */

    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .top-title {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .top-title-main {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    .top-title-sub {
      font-size: 12px;
      opacity: 0.72;
    }

    .top-profile-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px 6px 6px;
      background: rgba(0, 0, 0, 0.32);
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      box-shadow: 0 0 0 1px rgba(77, 255, 77, 0.08);
    }

    .top-profile-chip-inner {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .top-profile-avatar {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: linear-gradient(145deg, #7cff4b, #2bc144);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      color: #042407;
    }

    .top-profile-labels {
      display: flex;
      flex-direction: column;
      line-height: 1.1;
    }

    .top-profile-label-main {
      font-size: 11px;
      font-weight: 600;
      opacity: 0.86;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .top-profile-label-sub {
      font-size: 12px;
      opacity: 0.76;
    }

    .top-profile-chevron {
      font-size: 14px;
      opacity: 0.8;
    }

    button,
    .clickable {
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    /* Super balance card */

    .card {
      background: radial-gradient(circle at top left, #0b4b22 0, #031a0b 55%);
      border-radius: var(--radius-xl);
      padding: 18px 18px 16px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(120, 255, 160, 0.12);
      position: relative;
      overflow: hidden;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .card-kicker {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      opacity: 0.7;
    }

    .card-title-large {
      font-size: 24px;
      font-weight: 700;
      margin-top: 4px;
    }

    .badge-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(0, 0, 0, 0.4);
      font-size: 11px;
    }

    .badge-pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 4px rgba(77, 255, 77, 0.2);
    }

    .balance-main-row {
      display: flex;
      align-items: flex-end;
      gap: 6px;
      margin-bottom: 8px;
    }

    .balance-amount {
      font-size: 32px;
      font-weight: 800;
      letter-spacing: 0.02em;
    }

    .balance-currency {
      font-size: 16px;
      opacity: 0.82;
      margin-bottom: 4px;
    }

    .balance-week-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border-radius: var(--radius-pill);
      background: rgba(0, 0, 0, 0.35);
      padding: 4px 10px 4px 4px;
      margin-top: 4px;
    }

    .balance-week-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: var(--radius-pill);
      background: var(--accent-soft);
      padding: 3px 8px;
      font-size: 11px;
      font-weight: 600;
      color: var(--accent-strong);
    }

    .balance-week-pill span:first-child {
      font-size: 12px;
    }

    .balance-week-label {
      font-size: 11px;
      opacity: 0.8;
    }

    /* Assets breakdown toggle */

    .assets-toggle-row {
      display: flex;
      justify-content: flex-end;
      margin-top: 4px;
    }

    .assets-toggle-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 11px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: rgba(0, 0, 0, 0.4);
      font-size: 11px;
    }

    .assets-toggle-btn span.chevron {
      font-size: 11px;
      opacity: 0.86;
    }

    .assets-breakdown {
      margin-top: 10px;
      border-radius: 20px;
      background: rgba(0, 0, 0, 0.34);
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 10px 12px 8px;
      display: none;
      backdrop-filter: blur(14px);
    }

    .assets-breakdown.open {
      display: block;
    }

    .asset-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      padding: 4px 0;
    }

    .asset-row-label {
      opacity: 0.86;
    }

    .asset-row-value {
      font-variant-numeric: tabular-nums;
      font-weight: 600;
    }

    .asset-row-tag {
      font-size: 10px;
      opacity: 0.7;
    }

    /* Action tabs */

    .actions-row {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin-top: 14px;
    }

    .action-tab {
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: rgba(0, 0, 0, 0.32);
      padding: 9px 6px 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-soft);
    }

    .action-tab-icon {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.7);
    }

    .action-tab-icon span {
      font-size: 14px;
    }

    .action-tab.active {
      border-color: rgba(134, 255, 148, 0.95);
      background: radial-gradient(circle at top, #5cf44a, #098329);
      color: #042307;
      box-shadow: 0 10px 24px rgba(2, 0, 0, 0.7);
    }

    .action-tab.active .action-tab-icon {
      background: rgba(3, 40, 11, 0.9);
    }

    .action-tab.active .action-tab-icon span {
      color: var(--accent);
    }

    /* Mode panel (Quick Transfer / Exchange / Crypto / Stocks) */

    .panel {
      margin-top: 14px;
      background: radial-gradient(circle at top, #041f10 0, #020a05 70%);
      border-radius: var(--radius-xl);
      padding: 18px 18px 16px;
      border: 1px solid rgba(120, 255, 160, 0.1);
      box-shadow: var(--shadow-soft);
    }

    .panel-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .panel-subtitle {
      font-size: 12px;
      opacity: 0.8;
      margin-bottom: 14px;
      line-height: 1.35;
    }
.field-label {
      font-size: 12px;
      margin-bottom: 4px;
      opacity: 0.82;
    }

    .field-label span.hint {
      opacity: 0.65;
      font-size: 11px;
    }

    .field {
      margin-bottom: 12px;
    }

    .input-shell {
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-soft);
      background: rgba(0, 0, 0, 0.4);
      padding: 12px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 14px;
    }

    select,
    input[type="number"],
    input[type="text"] {
      border: none;
      outline: none;
      background: transparent;
      color: var(--text-main);
      font-size: 14px;
      width: 100%;
    }

    select {
      -webkit-appearance: none;
      appearance: none;
    }

    .input-shell select {
      padding-right: 16px;
    }

    .input-shell-amount {
      font-variant-numeric: tabular-nums;
    }

    .fee-box {
      margin-top: 10px;
      border-radius: 20px;
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 10px 12px 8px;
      font-size: 12px;
    }

    .fee-title-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      font-weight: 600;
    }

    .fee-row {
      display: flex;
      justify-content: space-between;
      padding: 2px 0;
    }

    .fee-row-label {
      opacity: 0.78;
    }

    .fee-row-value {
      font-variant-numeric: tabular-nums;
    }

    .primary-btn {
      width: 100%;
      margin-top: 16px;
      padding: 14px 10px;
      border-radius: 999px;
      border: none;
      font-weight: 700;
      font-size: 15px;
      background: linear-gradient(135deg, #9bff4d, #34c759);
      color: #021204;
      box-shadow: 0 10px 26px rgba(0, 0, 0, 0.8);
    }

    .primary-btn:active {
      transform: translateY(1px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.8);
    }

    .demo-note {
      margin-top: 8px;
      font-size: 11px;
      opacity: 0.78;
    }

    .demo-status {
      margin-top: 6px;
      font-size: 11px;
      color: var(--accent-strong);
    }

    /* Profile modal */

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.72);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 20;
    }

    .modal-backdrop.open {
      display: flex;
    }

    .modal-sheet {
      width: 100%;
      max-width: 540px;
      border-radius: 24px 24px 0 0;
      background: radial-gradient(circle at top, #083519 0, #020703 70%);
      border-top: 1px solid rgba(120, 255, 160, 0.2);
      padding: 16px 18px 20px;
      box-shadow: 0 -12px 40px rgba(0, 0, 0, 0.85);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 700;
    }

    .modal-close {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .profile-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      font-size: 13px;
    }

    .profile-row-label {
      opacity: 0.8;
    }

    .profile-row-value {
      font-variant-numeric: tabular-nums;
      font-weight: 500;
    }

    .modal-divider {
      margin: 10px 0;
      border-bottom: 1px dashed rgba(255, 255, 255, 0.18);
    }

    .modal-btn-row {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 6px;
    }

    .secondary-btn,
    .danger-btn {
      width: 100%;
      padding: 11px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.16);
      font-size: 14px;
    }

    .secondary-btn {
      background: rgba(0, 0, 0, 0.4);
      color: var(--text-main);
    }

    .danger-btn {
      background: var(--danger);
      border-color: rgba(255, 255, 255, 0.22);
      color: #fff;
      font-weight: 600;
    }

    /* Small helpers */

    .hidden {
      display: none !important;
    }

    @media (min-width: 480px) {
      #app {
        max-width: 480px;
        margin: 0 auto;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Top bar -->
    <div class="top-bar">
      <div class="top-title">
        <div class="top-title-main">AiSend</div>
        <div class="top-title-sub">Cross-border demo super balance</div>
      </div>
      <button class="top-profile-chip" id="profileChip">
        <div class="top-profile-chip-inner">
          <div class="top-profile-avatar" id="profileChipAvatar">M</div>
          <div class="top-profile-labels">
            <span class="top-profile-label-main">PROFIL</span>
            <span class="top-profile-label-sub" id="profileChipLabel">@demo</span>
          </div>
        </div>
        <span class="top-profile-chevron">â–¾</span>
      </button>
    </div>

    <!-- Super balance card -->
    <div class="card" id="superCard">
      <div class="card-header">
        <div>
          <div class="card-kicker">AISEND Â· DEMO</div>
          <div class="card-title-large">Super balance</div>
        </div>
        <button class="badge-pill assets-toggle-btn" id="assetsToggleBtn">
          <span id="assetsToggleLabel">Barcha aktivlar</span>
          <span class="chevron" id="assetsToggleChevron">â–¾</span>
        </button>
      </div>

      <div class="balance-main-row">
        <div class="balance-amount" id="totalBalanceLabel">12 450.00</div>
        <div class="balance-currency">USZ</div>
      </div>

      <div class="balance-week-chip">
        <div class="balance-week-pill">
          <span>â¬†</span><span id="weekChangeLabel">+3.4%</span>
        </div>
        <span class="balance-week-label">Oxirgi hafta (demo)</span>
      </div>

      <div class="assets-breakdown" id="assetsBreakdown">
        <div class="asset-row">
          <div>
            <div class="asset-row-label">Fiat balans</div>
            <div class="asset-row-tag">UZS / KZT / KGS (demo)</div>
          </div>
          <div class="asset-row-value" id="fiatBalanceLabel">9 200.00 USZ</div>
        </div>
        <div class="asset-row">
          <div>
            <div class="asset-row-label">Crypto (demo)</div>
            <div class="asset-row-tag">BTC Â· ETH Â· USDT (demo)</div>
          </div>
          <div class="asset-row-value" id="cryptoBalanceLabel">2 150.45 USZ</div>
        </div>
        <div class="asset-row">
          <div>
            <div class="asset-row-label">Stocks (demo)</div>
            <div class="asset-row-tag">US / KZ bozorlar (demo)</div>
          </div>
          <div class="asset-row-value" id="stocksBalanceLabel">1 099.55 USZ</div>
        </div>
      </div>

      <!-- Action tabs -->
      <div class="actions-row">
        <button class="action-tab active" data-mode="send">
          <div class="action-tab-icon"><span>â†—</span></div>
          <div>Send</div>
        </button>
        <button class="action-tab" data-mode="exchange">
          <div class="action-tab-icon"><span>â‡„</span></div>
          <div>Exchange</div>
        </button>
        <button class="action-tab" data-mode="crypto">
          <div class="action-tab-icon"><span>â‚¿</span></div>
          <div>Crypto</div>
        </button>
        <button class="action-tab" data-mode="stocks">
          <div class="action-tab-icon"><span>ðŸ“ˆ</span></div>
          <div>Stocks</div>
        </button>
      </div>
    </div>

    <!-- Mode panel (re-used; sarlavha JS orqali almashadi) -->
    <div class="panel">
      <div class="panel-title" id="modeTitle">Quick Transfer</div>
      <div class="panel-subtitle" id="modeSubtitle">
        UZS â†’ KZT / KGS kartaga tezkor oâ€˜tkazmalar (demo). Komissiya tarkibini
        oldindan koâ€˜rib turasiz.
      </div>

      <div class="field">
        <div class="field-label">From valyuta</div>
        <div class="input-shell">
          <select id="fromCurrency">
            <option value="UZS" selected>UZS (Uzbekistan)</option>
          </select>
        </div>
      </div>

      <div class="field">
        <div class="field-label">To valyuta</div>
        <div class="input-shell">
          <select id="toCurrency">
            <option value="KZT" selected>KZT (Kazakhstan)</option>
            <option value="KGS">KGS (Kyrgyzstan)</option>
          </select>
        </div>
      </div>

      <div class="field">
        <div class="field-label">Miqdor</div>
        <div class="input-shell input-shell-amount">
          <input
            id="amountInput"
            type="number"
            min="0"
            step="1"
            placeholder="Miqdor kiriting"
          />
        </div>
      </div>

      <div class="field">
        <div class="field-label">
          Qabul qiluvchi (demo)
          <span class="hint">@username yoki karta raqam</span>
        </div>
        <div class="input-shell">
          <input
            id="recipientInput"
            type="text"
            placeholder="@foydalanuvchi yoki karta 0000..."
          />
        </div>
      </div>

      <div class="fee-box">
        <div class="fee-title-row">
          <span>Qabul qiluvchi oladi (taxminan)</span>
          <span class="fee-row-value" id="receiveEstimate">0,00 KZT</span>
        </div>
        <div class="fee-row">
          <span class="fee-row-label">Exchange fee (1%)</span>
          <span class="fee-row-value" id="feeExchange">0,00 KZT</span>
        </div>
        <div class="fee-row">
          <span class="fee-row-label">Transfer fee (1%)</span>
          <span class="fee-row-value" id="feeTransfer">0,00 KZT</span>
        </div>
        <div class="fee-row">
          <span class="fee-row-label">Umumiy komissiya</span>
          <span class="fee-row-value" id="feeTotal">0,00 KZT</span>
        </div>
      </div>

      <button class="primary-btn" id="confirmButton">
        Yuborishni tasdiqlash (demo)
      </button>
      <div class="demo-note">
        Demo: 1% exchange + 1% transfer komissiya. Real ilovada bu raqamlar
        litsenziyaga qarab oâ€˜zgaradi.
      </div>
      <div class="demo-status" id="demoStatus"></div>
    </div>

    <!-- Profile modal -->
    <div class="modal-backdrop" id="profileModal">
      <div class="modal-sheet">
        <div class="modal-header">
          <div class="modal-title">Telegram profil</div>
          <button class="modal-close" id="profileModalClose">âœ•</button>
        </div>
        <div class="profile-row">
          <span class="profile-row-label">Ism:</span>
          <span class="profile-row-value" id="profileName">-</span>
        </div>
        <div class="profile-row">
          <span class="profile-row-label">ID:</span>
          <span class="profile-row-value" id="profileId">-</span>
        </div>
        <div class="profile-row">
          <span class="profile-row-label">Username:</span>
          <span class="profile-row-value" id="profileUsername">-</span>
        </div>
        <div class="modal-divider"></div>
        <div class="modal-btn-row">
          <button class="secondary-btn">Sozlamalar (tez orada)</button>
          <button class="danger-btn">Chiqish (tez orada)</button>
        </div>
      </div>
    </div>
  </div>
<script>
    // --- Demo balanslar ---
    const DEMO_BALANCES = {
      fiat: 9200,
      crypto: 2150.45,
      stocks: 1099.55,
    };

    const DEMO_WEEK_CHANGE = 3.4; // %

    // Demo kurs: 1 UZS -> 0.040 KZT (faqat UI uchun)
    const DEMO_BASE_RATES = {
      "UZS_KZT": 0.04,
      "UZS_KGS": 0.0085,
    };

    let currentMode = "send";

    function formatUsz(amount) {
      return amount.toLocaleString("ru-RU", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      });
    }

    function formatCurrency(amount, code) {
      const num = amount || 0;
      const base = num.toLocaleString("ru-RU", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      });
      return `${base} ${code}`;
    }

    function initBalances() {
      const total =
        DEMO_BALANCES.fiat + DEMO_BALANCES.crypto + DEMO_BALANCES.stocks;
      document.getElementById("totalBalanceLabel").textContent =
        formatUsz(total);
      document.getElementById("fiatBalanceLabel").textContent =
        formatUsz(DEMO_BALANCES.fiat) + " USZ";
      document.getElementById("cryptoBalanceLabel").textContent =
        formatUsz(DEMO_BALANCES.crypto) + " USZ";
      document.getElementById("stocksBalanceLabel").textContent =
        formatUsz(DEMO_BALANCES.stocks) + " USZ";
      document.getElementById("weekChangeLabel").textContent =
        (DEMO_WEEK_CHANGE > 0 ? "+" : "") + DEMO_WEEK_CHANGE.toFixed(1) + "%";
    }

    // --- Assets toggle ("Barcha aktivlar / Yopish") ---
    function setupAssetsToggle() {
      const btn = document.getElementById("assetsToggleBtn");
      const label = document.getElementById("assetsToggleLabel");
      const chevron = document.getElementById("assetsToggleChevron");
      const breakdown = document.getElementById("assetsBreakdown");

      let open = false;

      btn.addEventListener("click", () => {
        open = !open;
        breakdown.classList.toggle("open", open);
        if (open) {
          label.textContent = "Yopish";
          chevron.textContent = "â–²";
        } else {
          label.textContent = "Barcha aktivlar";
          chevron.textContent = "â–¾";
        }
      });
    }

    // --- Tabs (Send / Exchange / Crypto / Stocks) ---

    const MODE_COPY = {
      send: {
        title: "Quick Transfer",
        subtitle:
          "UZS â†’ KZT / KGS kartaga tezkor oâ€˜tkazmalar (demo). Komissiyani oldindan koâ€˜rasiz.",
      },
      exchange: {
        title: "Exchange (demo)",
        subtitle:
          "Balansingizdagi UZS ni ichki AiSend KZT / KGS balansiga almashtiring. 1% exchange komissiya (demo).",
      },
      crypto: {
        title: "Crypto (demo)",
        subtitle:
          "Fiat balansni USDT / BTC / ETH ga almashtirish konsepti. Hozircha faqat kalkulyator va komissiya koâ€˜rsatkichi.",
      },
      stocks: {
        title: "Stocks (demo)",
        subtitle:
          "US va KZ fond bozorlariga demo ekspozitsiya. Pul oâ€˜tkazmasi logikasi real stok broker integratsiyasi uchun tayyorlanmoqda.",
      },
    };

    function setMode(mode) {
      currentMode = mode;

      const cfg = MODE_COPY[mode] || MODE_COPY["send"];
      document.getElementById("modeTitle").textContent = cfg.title;
      document.getElementById("modeSubtitle").textContent = cfg.subtitle;

      document
        .querySelectorAll(".action-tab")
        .forEach((el) =>
          el.classList.toggle("active", el.getAttribute("data-mode") === mode)
        );

      // Komissiya yozuvlarini ham moslashtiramiz (faqat matn)
      const feeTitle = document.querySelector(".fee-title-row span");
      if (mode === "send") {
        feeTitle.textContent = "Qabul qiluvchi oladi (taxminan)";
      } else if (mode === "exchange") {
        feeTitle.textContent = "Balansga tushadigan summa (taxminan)";
      } else if (mode === "crypto") {
        feeTitle.textContent = "Sotib olinadigan kripto (taxminan)";
      } else if (mode === "stocks") {
        feeTitle.textContent = "Aksiya qiymati (taxminan)";
      }

      recalcDemo();
    }

    function setupTabs() {
      document.querySelectorAll(".action-tab").forEach((btn) => {
        btn.addEventListener("click", () => {
          const mode = btn.getAttribute("data-mode");
          setMode(mode);
        });
      });
    }

    // --- Telegram WebApp profiling ---

    function initTelegramProfile() {
      let name = "";
      let id = "";
      let username = "";

      try {
        const tg = window.Telegram && window.Telegram.WebApp;
        if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
          const u = tg.initDataUnsafe.user;
          if (u.first_name || u.last_name) {
            name = [u.first_name, u.last_name].filter(Boolean).join(" ");
          }
          if (u.id) {
            id = String(u.id);
          }
          if (u.username) {
            username = u.username;
          }
        } else {
          // Fallback: URL query params (tg_name, tg_id, tg_username)
          const params = new URLSearchParams(window.location.search);
          if (params.has("tg_name")) name = params.get("tg_name") || "";
          if (params.has("tg_id")) id = params.get("tg_id") || "";
          if (params.has("tg_username"))
            username = params.get("tg_username") || "";
        }
      } catch (e) {
        console.warn("Telegram initDataUnsafe oâ€˜qishda xato:", e);
      }

      const nameLabel = document.getElementById("profileName");
      const idLabel = document.getElementById("profileId");
      const userLabel = document.getElementById("profileUsername");

      nameLabel.textContent = name || "-";
      idLabel.textContent = id || "-";
      userLabel.textContent = username ? "@" + username : "-";

      const chipLabel = document.getElementById("profileChipLabel");
      const chipAvatar = document.getElementById("profileChipAvatar");

      if (name) {
        chipLabel.textContent = name;
        chipAvatar.textContent = name[0].toUpperCase();
      } else if (username) {
        chipLabel.textContent = "@" + username;
        chipAvatar.textContent = username[0].toUpperCase();
      } else {
        chipLabel.textContent = "@demo";
        chipAvatar.textContent = "M";
      }
    }

    // --- Profile modal open / close ---

    function setupProfileModal() {
      const chip = document.getElementById("profileChip");
      const modal = document.getElementById("profileModal");
      const closeBtn = document.getElementById("profileModalClose");

      const open = () => modal.classList.add("open");
      const close = () => modal.classList.remove("open");

      chip.addEventListener("click", open);
      closeBtn.addEventListener("click", close);
      modal.addEventListener("click", (e) => {
        if (e.target === modal) close();
      });
    }

    // --- Demo kalkulyator & komissiya ---

    function getCurrentRate() {
      const from = document.getElementById("fromCurrency").value;
      const to = document.getElementById("toCurrency").value;
      const key = `${from}_${to}`;
      return DEMO_BASE_RATES[key] || 0;
    }

    function recalcDemo() {
      const amountInput = document.getElementById("amountInput");
      const receiveLabel = document.getElementById("receiveEstimate");
      const feeExchangeLabel = document.getElementById("feeExchange");
      const feeTransferLabel = document.getElementById("feeTransfer");
      const feeTotalLabel = document.getElementById("feeTotal");
      const to = document.getElementById("toCurrency").value;

      const rawAmount = parseFloat(amountInput.value.replace(",", ".")) || 0;
      const rate = getCurrentRate();

      if (!rate || rawAmount <= 0) {
        receiveLabel.textContent = formatCurrency(0, to);
        feeExchangeLabel.textContent = formatCurrency(0, to);
        feeTransferLabel.textContent = formatCurrency(0, to);
        feeTotalLabel.textContent = formatCurrency(0, to);
        return;
      }

      const gross = rawAmount * rate;
      const feeExchange = gross * 0.01;
      const feeTransfer = gross * 0.01;
      const feeTotal = feeExchange + feeTransfer;
      const receive = gross - feeTotal;

      receiveLabel.textContent = formatCurrency(receive, to);
      feeExchangeLabel.textContent = formatCurrency(feeExchange, to);
      feeTransferLabel.textContent = formatCurrency(feeTransfer, to);
      feeTotalLabel.textContent = formatCurrency(feeTotal, to);
    }
function setupDemoCalculator() {
      document
        .getElementById("amountInput")
        .addEventListener("input", recalcDemo);
      document
        .getElementById("toCurrency")
        .addEventListener("change", recalcDemo);
    }

    function setupConfirmButton() {
      const btn = document.getElementById("confirmButton");
      const status = document.getElementById("demoStatus");
      const amountInput = document.getElementById("amountInput");
      const recipientInput = document.getElementById("recipientInput");

      btn.addEventListener("click", () => {
        const amount = parseFloat(amountInput.value.replace(",", ".")) || 0;
        const recipient = recipientInput.value.trim();
        const to = document.getElementById("toCurrency").value;

        if (!amount || amount <= 0) {
          status.textContent = "Avval miqdorni kiriting (demo).";
          return;
        }

        const baseMsg =
          currentMode === "send"
            ? "Demo: toâ€˜lov yuborildi âœ”ï¸"
            : currentMode === "exchange"
            ? "Demo: balans ichida exchange bajarildi âœ”ï¸"
            : currentMode === "crypto"
            ? "Demo: kripto sotib olindi âœ”ï¸"
            : "Demo: stocks portfelingiz yangilandi âœ”ï¸";

        const recPart = recipient
          ? ` Qabul qiluvchi: ${recipient}, valyuta: ${to}.`
          : ` Valyuta: ${to}.`;

        status.textContent = baseMsg + recPart;

        try {
          const tg = window.Telegram && window.Telegram.WebApp;
          if (tg && tg.HapticFeedback) {
            tg.HapticFeedback.impactOccurred("light");
          }
        } catch (e) {
          // hech narsa qilmaymiz
        }

        const originalText = btn.textContent;
        btn.textContent = "Tasdiqlandi (demo)";
        btn.disabled = true;
        setTimeout(() => {
          btn.textContent = originalText;
          btn.disabled = false;
        }, 1200);
      });
    }

    // --- Init ---

    document.addEventListener("DOMContentLoaded", () => {
      try {
        const tg = window.Telegram && window.Telegram.WebApp;
        if (tg && tg.ready) tg.ready();
      } catch (e) {
        console.warn("Telegram.WebApp.ready chaqirib boâ€˜lmadi:", e);
      }

      initBalances();
      setupAssetsToggle();
      setupTabs();
      initTelegramProfile();
      setupProfileModal();
      setupDemoCalculator();
      setupConfirmButton();
      setMode("send"); // default
      recalcDemo();
    });
  </script>
</body>
</html>
