<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <title>AiSend · Super Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #021608;
      --card: #05250f;
      --accent: #1dd24a;
      --accent-soft: #b5ff6f;
      --accent-dark: #0b752a;
      --text-main: #ffffff;
      --text-muted: #a7bfa7;
      --danger: #ff5b5b;
      --border-soft: rgba(255, 255, 255, 0.05);
      --radius-xl: 22px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Roboto", sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #063517 0, #021608 55%, #010705 100%);
      color: var(--text-main);
      min-height: 100vh;
    }

    .app {
      min-height: 100vh;
      padding: 16px 14px 24px;
      max-width: 480px;
      margin: 0 auto;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .logo-title {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-badge {
      width: 42px;
      height: 42px;
      border-radius: 18px;
      background: radial-gradient(circle at 30% 20%, #9fff7a 0, #0fb741 40%, #021608 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 22px;
      color: #021608;
      box-shadow: 0 0 24px rgba(43, 255, 117, 0.35);
    }

    .app-name {
      font-size: 24px;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    .app-sub {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .profile-btn {
      padding: 8px 16px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.2), rgba(20, 50, 30, 0.9));
      color: var(--text-main);
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .profile-btn span {
      font-size: 10px;
      opacity: 0.8;
    }

    .card {
      background: radial-gradient(circle at top left, #06351a 0, #021608 45%, #010705 100%);
      border-radius: 26px;
      padding: 18px 18px 18px;
      border: 1px solid var(--border-soft);
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.6);
      margin-bottom: 14px;
    }

    .balance-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .balance-label {
      font-size: 12px;
      color: rgba(209, 250, 229, 0.9);
      text-transform: uppercase;
      letter-spacing: 0.16em;
    }

    .balance-main {
      font-size: 26px;
      font-weight: 700;
      margin-top: 2px;
    }

    .balance-sub {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .balance-toggle-btn {
      border: none;
      background: rgba(15, 23, 42, 0.6);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 11px;
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      border: 1px solid rgba(148, 163, 184, 0.5);
    }

    .balance-toggle-btn span.arrow {
      display: inline-block;
      transition: transform 0.18s ease;
    }

    .balance-toggle-btn.open span.arrow {
      transform: rotate(180deg);
    }

    .balance-details {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed rgba(148, 163, 184, 0.6);
      display: none;
    }

    .balance-details.open {
      display: block;
    }

    .asset-row {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      margin: 5px 0;
    }

    .asset-row span.label {
      color: var(--text-muted);
    }

    .asset-row span.value {
      font-weight: 500;
    }

    .asset-row span.tag {
      font-size: 11px;
      margin-left: 6px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(74, 222, 128, 0.55);
      color: #bbf7d0;
    }

    .main-tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 4px;
      overflow-x: auto;
      padding-bottom: 4px;
    }

    .main-tab-btn {
      flex: 0 0 auto;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      padding: 7px 12px;
      font-size: 12px;
      background: rgba(15, 23, 42, 0.85);
      color: #e5e7eb;
      cursor: pointer;
    }

    .main-tab-btn.active {
      border-color: rgba(74, 222, 128, 0.9);
      background: radial-gradient(circle at 10% 0, #bef264 0, #22c55e 45%, #065f46 100%);
      color: #022c22;
      box-shadow: 0 0 16px rgba(22, 163, 74, 0.55);
    }

    .page-section {
      display: none;
      margin-top: 8px;
    }

    .page-section.active {
      display: block;
    }

    label {
      display: block;
      font-size: 13px;
      margin-bottom: 6px;
    }

    select,
    input[type="text"],
    input[type="number"],
    textarea {
      width: 100%;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      background: rgba(0, 0, 0, 0.35);
      color: var(--text-main);
      padding: 11px 12px;
      font-size: 14px;
      outline: none;
    }

    select {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: linear-gradient(45deg, transparent 50%, #9ca3af 50%),
        linear-gradient(135deg, #9ca3af 50%, transparent 50%);
      background-position: calc(100% - 14px) 13px, calc(100% - 10px) 13px;
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
    }

    select:focus,
    input:focus,
    textarea:focus {
      border-color: rgba(74, 222, 128, 0.8);
      box-shadow: 0 0 0 1px rgba(74, 222, 128, 0.2);
    }

    .field {
      margin-bottom: 12px;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 14px 18px;
      font-size: 16px;
      font-weight: 600;
      width: 100%;
      text-align: center;
      cursor: pointer;
      color: #022c15;
      background: linear-gradient(90deg, #bef264, #4ade80);
      box-shadow: 0 14px 30px rgba(22, 163, 74, 0.55);
      margin-top: 6px;
    }

    .btn:active {
      transform: translateY(1px);
      box-shadow: 0 8px 20px rgba(22, 163, 74, 0.4);
    }

    .btn-loading {
      opacity: 0.7;
    }

    .btn-secondary {
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      box-shadow: none;
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      font-size: 14px;
    }

    .result-main {
      margin-top: 10px;
      font-size: 18px;
      font-weight: 600;
    }

    .result-sub {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .rate-error {
      margin-top: 4px;
      font-size: 12px;
      color: var(--danger);
    }

    .inline-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 10px;
    }

    .inline-badge {
      font-size: 11px;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: #e5e7eb;
      background: rgba(15, 23, 42, 0.8);
    }

    .avatar-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .avatar {
      width: 46px;
      height: 46px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, #a7f3d0 0, #22c55e 40%, #047857 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
      color: #022c15;
      box-shadow: 0 0 18px rgba(34, 197, 94, 0.7);
    }

    .avatar-text-main {
      font-size: 15px;
      font-weight: 600;
    }

    .avatar-text-sub {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .send-status {
      margin-top: 8px;
      font-size: 12px;
      color: #bbf7d0;
    }

    .send-status.err {
      color: var(--danger);
    }

    .footer-note {
      font-size: 11px;
      color: var(--text-muted);
      text-align: center;
      margin-top: 10px;
      line-height: 1.4;
    }

    /* PROFILE MODAL */
    .modal-bg {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.72);
      backdrop-filter: blur(10px);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 40;
    }

    .modal-bg.active {
      display: flex;
    }

    .modal {
      width: 100%;
      max-width: 480px;
      border-radius: 24px 24px 0 0;
      padding: 18px 18px 22px;
      background: radial-gradient(circle at top, #022c1f 0, #010b07 55%, #000 100%);
      border-top: 1px solid rgba(74, 222, 128, 0.45);
      box-shadow: 0 -12px 40px rgba(0, 0, 0, 0.7);
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
    }

    .modal-close {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      cursor: pointer;
    }

    .modal-row {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      margin: 6px 0;
    }

    .modal-row label {
      margin: 0;
      color: var(--text-muted);
      font-size: 13px;
    }

    .modal-row span {
      font-weight: 500;
    }

    .modal-separator {
      border-top: 1px dashed rgba(148, 163, 184, 0.65);
      margin: 10px 0 14px;
    }

    .pill {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: #e5e7eb;
      background: rgba(15, 23, 42, 0.85);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
    }

    @media (min-width: 480px) {
      .app {
        padding-top: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <div class="logo-title">
        <div class="logo-badge">A</div>
        <div>
          <div class="app-name">AiSend</div>
          <div class="app-sub">Chegarasiz to‘lovlar · demo</div>
        </div>
      </div>
      <button class="profile-btn" id="profileOpen">
        Profil
        <span>▼</span>
      </button>
    </header>

    <!-- BALANCE CARD + BARCHA AKTIVLAR -->
    <section class="card">
      <div class="balance-header-row">
        <div>
          <div class="balance-label">Total balance</div>
          <div class="balance-main" id="totalBalance">12 540 000 UZS</div>
          <div class="balance-sub">≈ 430 000 KZT · 105 USDT (demo)</div>
        </div>
        <button class="balance-toggle-btn" id="balanceToggle">
          Barcha aktivlar
          <span class="arrow">▾</span>
        </button>
      </div>
      <div class="balance-details" id="balanceDetails">
        <div class="asset-row">
          <span class="label">Fiat (UZS + KZT)</span>
          <span class="value">9 800 000 UZS<span class="tag">fiat</span></span>
        </div>
        <div class="asset-row">
          <span class="label">Crypto</span>
          <span class="value">105 USDT<span class="tag">crypto</span></span>
        </div>
        <div class="asset-row">
          <span class="label">Stocks</span>
          <span class="value">1 250 USDT<span class="tag">stock</span></span>
        </div>
      </div>
    </section>

    <!-- TAB MENU -->
    <div class="main-tabs">
      <button class="main-tab-btn active" data-tab="send">Send</button>
      <button class="main-tab-btn" data-tab="exchange">Exchange</button>
      <button class="main-tab-btn" data-tab="crypto">Crypto</button>
      <button class="main-tab-btn" data-tab="stocks">Stocks</button>
      <button class="main-tab-btn" data-tab="borderless">Chegarasiz to‘lovlar</button>
    </div>

    <main>
      <!-- PAGE: SEND -->
      <section id="page-send" class="page-section active">
        <section class="card">
          <div class="inline-badges" style="margin-bottom: 8px;">
            <span class="inline-badge">AiSend → AiSend</span>
            <span class="inline-badge">0% komissiya (demo)</span>
          </div>
          <div class="avatar-row">
            <div class="avatar">AV</div>
            <div>
              <div class="avatar-text-main" id="friendName">Alisher Valiyev</div>
              <div class="avatar-text-sub" id="friendPhone">+998 90 123 45 67</div>
            </div>
          </div>
          <div class="field">
            <label for="sendAmount">Miqdor</label>
            <input id="sendAmount" type="number" inputmode="numeric" placeholder="Miqdor kiriting" />
          </div>
          <div class="field">
            <label for="sendCurrency">Valyuta</label>
            <select id="sendCurrency">
              <option value="UZS" selected>UZS</option>
              <option value="KZT">KZT</option>
            </select>
          </div>
          <div class="field">
            <label for="sendNote">Izoh (ixtiyoriy)</label>
            <input id="sendNote" type="text" placeholder="Masalan: “Uyga pul”" />
          </div>
          <button class="btn" id="sendHoldBtn">
            Yuborish uchun ushlab turing
          </button>
          <div class="send-status" id="sendStatus">
            Demo: to‘lov yuborishga tayyor ✅
          </div>
        </section>
      </section>
<!-- PAGE: EXCHANGE -->
      <section id="page-exchange" class="page-section">
        <section class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
            <div>
              <div style="font-size:18px;font-weight:600;">Valyuta almashish</div>
              <div style="font-size:12px;color:var(--text-muted);margin-top:4px;">
                UZS balansdan KZT/KGS kartaga yo‘nalish (demo kurs).
              </div>
            </div>
            <div class="pill">
              <span class="pill-dot"></span>
              <span id="rateModeLabel">Onlayn kurslar</span>
            </div>
          </div>

          <div class="field">
            <label for="direction">Yo‘nalishni tanlang</label>
            <select id="direction">
              <option value="UZS_KZT" selected>UZS → KZT</option>
              <option value="UZS_KGS">UZS → KGS</option>
            </select>
          </div>

          <div class="field">
            <label for="amount">Miqdor (UZS)</label>
            <input id="amount" type="number" inputmode="numeric" placeholder="Miqdor kiriting" />
          </div>

          <div class="field" style="display:flex;justify-content:space-between;align-items:center;margin-top:4px;">
            <span style="font-size:13px;color:var(--text-muted);">
              Onlayn kurslardan foydalanish
            </span>
            <label class="switch">
              <input type="checkbox" id="liveToggle" checked />
              <span class="slider"></span>
            </label>
          </div>

          <button class="btn" id="calcBtn">Hisoblash</button>

          <div class="result-main" id="resultBox">0 UZS ≈ 0 KZT</div>
          <div class="result-sub" id="baseRate">
            1 UZS ≈ demo kurs
          </div>
          <div class="rate-error" id="rateError"></div>
        </section>
      </section>

      <!-- PAGE: CRYPTO DEMO -->
      <section id="page-crypto" class="page-section">
        <section class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <div>
              <div style="font-size:18px;font-weight:600;">Crypto wallet (demo)</div>
              <div style="font-size:12px;color:var(--text-muted);margin-top:4px;">
                KYC va litsenziyadan so‘ng to‘liq ishga tushiriladi.
              </div>
            </div>
            <span class="pill">
              <span class="pill-dot"></span>
              <span>Coming soon</span>
            </span>
          </div>

          <div class="asset-row">
            <span class="label">USDT</span>
            <span class="value">105.00 USDT</span>
          </div>
          <div class="asset-row">
            <span class="label">BTC</span>
            <span class="value">0.0031 BTC</span>
          </div>
          <div class="asset-row">
            <span class="label">TON</span>
            <span class="value">42.0 TON</span>
          </div>

          <button class="btn-secondary" style="margin-top:12px;">
            Crypto bo‘limi demo rejimida
          </button>
        </section>
      </section>

      <!-- PAGE: STOCKS DEMO -->
      <section id="page-stocks" class="page-section">
        <section class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <div>
              <div style="font-size:18px;font-weight:600;">Stocks (demo)</div>
              <div style="font-size:12px;color:var(--text-muted);margin-top:4px;">
                Global aksiyalar portfeli (demo maʼlumotlar).
              </div>
            </div>
            <span class="pill">
              <span class="pill-dot"></span>
              <span>Demo</span>
            </span>
          </div>

          <div class="asset-row">
            <span class="label">AAPL</span>
            <span class="value">1 000 USDT<span class="tag">+2.3%</span></span>
          </div>
          <div class="asset-row">
            <span class="label">TSLA</span>
            <span class="value">150 USDT<span class="tag">-1.1%</span></span>
          </div>
          <div class="asset-row">
            <span class="label">NVDA</span>
            <span class="value">100 USDT<span class="tag">+4.5%</span></span>
          </div>

          <button class="btn-secondary" style="margin-top:12px;">
            Stock bo‘limi demo rejimida
          </button>
        </section>
      </section>

      <!-- PAGE: CHEGARASIZ TO'LOVLAR -->
      <section id="page-borderless" class="page-section">
        <section class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <div>
              <div style="font-size:18px;font-weight:600;">Chegarasiz to‘lovlar</div>
              <div style="font-size:12px;color:var(--text-muted);margin-top:4px;">
                Chet eldan turib O‘zbekistondagi komunal to‘lovlarni to‘lash (demo).
              </div>
            </div>
            <span class="pill">
              <span class="pill-dot"></span>
              <span>Beta idea</span>
            </span>
          </div>

          <div class="field">
            <label for="b_fromCountry">Qaysi davlatdansiz?</label>
            <select id="b_fromCountry">
              <option value="RU" selected>Rossiya (RUB bilan)</option>
              <option value="KZ">Qozog‘iston (KZT)</option>
              <option value="TR">Turkiya (TRY)</option>
            </select>
          </div>

          <div class="field">
            <label for="b_toService">O‘zbekistonda qaysi to‘lov?</label>
            <select id="b_toService">
              <option value="electric" selected>Elektr energiya</option>
              <option value="gas">Gaz</option>
              <option value="water">Suv</option>
              <option value="internet">Internet</option>
            </select>
          </div>

          <div class="field">
            <label for="b_account">Shaxsiy hisob / ID</label>
            <input id="b_account" type="text" placeholder="Masalan, hisob raqam / abonent ID" />
          </div>

          <div class="field">
            <label for="b_amount">To‘lov summasi (UZS)</label>
            <input id="b_amount" type="number" inputmode="numeric" placeholder="Masalan, 150000" />
          </div>

          <div class="field">
            <label for="b_currency">Qaysi valyutada to‘laysiz?</label>
            <select id="b_currency">
              <option value="RUB" selected>RUB (Rossiya)</option>
              <option value="KZT">KZT (Qozog‘iston)</option>
              <option value="TRY">TRY (Turkiya)</option>
            </select>
          </div>

          <button class="btn" id="borderlessBtn">
            To‘lovni tasdiqlash
          </button>
          <div class="send-status" id="borderlessStatus">
            Demo: komissiya va konvertatsiya faqat ko‘rsatma sifatida hisoblanadi.
          </div>
        </section>
      </section>

      <p class="footer-note">
        AiSend super demo interfeysi. Barcha kurslar va to‘lovlar test rejimida.
      </p>
    </main>
  </div>

  <!-- PROFILE MODAL -->
  <div class="modal-bg" id="profileBg">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Telegram profil</div>
        <div class="modal-close" id="profileClose">✕</div>
      </div>

      <div class="modal-row">
        <label>Ism:</label>
        <span id="pf_name">-</span>
      </div>
      <div class="modal-row">
        <label>ID:</label>
        <span id="pf_id">-</span>
      </div>
      <div class="modal-row">
        <label>Username:</label>
        <span id="pf_username">-</span>
      </div>

      <div class="modal-separator"></div>

      <button class="btn-secondary" style="margin-top: 4px;">
        Sozlamalar (tez orada)
      </button>
      <button class="btn" style="margin-top: 10px; background: #f97373; color:#450a0a; box-shadow:none;">
        Chiqish (tez orada)
      </button>
    </div>
  </div>
<script>
    // Format helper
    function fmt(num) {
      return Number(num).toLocaleString("uz-UZ", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    // ==== TABLAR ====
    function setupTabs() {
      const buttons = document.querySelectorAll(".main-tab-btn");
      const sections = document.querySelectorAll(".page-section");

      buttons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const tab = btn.dataset.tab;
          buttons.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");

          sections.forEach((sec) => {
            if (sec.id === "page-" + tab) {
              sec.classList.add("active");
            } else {
              sec.classList.remove("active");
            }
          });
        });
      });
    }

    // ==== BALANCE TOGGLE ====
    function setupBalanceToggle() {
      const toggleBtn = document.getElementById("balanceToggle");
      const details = document.getElementById("balanceDetails");
      if (!toggleBtn || !details) return;

      toggleBtn.addEventListener("click", () => {
        const isOpen = details.classList.toggle("open");
        toggleBtn.classList.toggle("open", isOpen);
      });
    }

    // ==== EXCHANGE (UZS → KZT/KGS) ====
    const DEMO_RATES = {
      UZS_KZT: 0.04,
      UZS_KGS: 0.007
    };

    let lastOnlineRates = {};
    let lastOnlineOk = false;

    function updateBaseRateLabel(code, rate, source) {
      const baseRateEl = document.getElementById("baseRate");
      let quote = "";
      if (code === "UZS_KZT") quote = "KZT";
      else if (code === "UZS_KGS") quote = "KGS";
      const srcText = source === "online" ? "onlayn API" : "demo kurs";
      if (baseRateEl) {
        baseRateEl.textContent = `1 UZS ≈ ${fmt(rate)} ${quote} (${srcText})`;
      }
    }

    async function fetchOnlineRates() {
      try {
        const res = await fetch(
          "https://api.exchangerate.host/latest?base=UZS&symbols=KZT,KGS"
        );
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        if (!data || !data.rates) throw new Error("Bad payload");
        const kzt = data.rates.KZT;
        const kgs = data.rates.KGS;
        if (!kzt || !kgs) throw new Error("No symbols");

        lastOnlineRates = {
          UZS_KZT: kzt,
          UZS_KGS: kgs
        };
        lastOnlineOk = true;
        const errEl = document.getElementById("rateError");
        if (errEl) errEl.textContent = "";
        return lastOnlineRates;
      } catch (e) {
        console.log("Rate fetch error:", e);
        lastOnlineOk = false;
        const errEl = document.getElementById("rateError");
        if (errEl) {
          errEl.textContent =
            "Onlayn kurs yuklanmadi. Demo kurs ishlatiladi.";
        }
        return null;
      }
    }

    async function recalc() {
      const amountEl = document.getElementById("amount");
      const directionEl = document.getElementById("direction");
      const toggleEl = document.getElementById("liveToggle");
      const resultEl = document.getElementById("resultBox");

      if (!amountEl || !directionEl || !toggleEl || !resultEl) return;

      const raw = amountEl.value.trim();
      const amt = parseFloat(raw.replace(",", "."));
      const dir = directionEl.value;

      if (!raw || isNaN(amt) || amt <= 0) {
        resultEl.textContent = `0 UZS ≈ 0 KZT`;
        return;
      }

      let source = "demo";
      let rate = DEMO_RATES[dir] || 0.04;

      if (toggleEl.checked) {
        if (!lastOnlineOk) {
          await fetchOnlineRates();
        }
        if (lastOnlineOk && lastOnlineRates[dir]) {
          rate = lastOnlineRates[dir];
          source = "online";
        } else {
          source = "demo";
        }
      }

      const quote = dir === "UZS_KZT" ? "KZT" : "KGS";
      const result = amt * rate;

      resultEl.textContent = `${fmt(amt)} UZS ≈ ${fmt(result)} ${quote}`;
      updateBaseRateLabel(dir, rate, source);
    }

    function setupCalcUI() {
      const calcBtn = document.getElementById("calcBtn");
      const amountEl = document.getElementById("amount");
      const directionEl = document.getElementById("direction");
      const toggleEl = document.getElementById("liveToggle");
      const modeLabel = document.getElementById("rateModeLabel");

      if (!calcBtn || !amountEl || !directionEl || !toggleEl) return;

      toggleEl.addEventListener("change", () => {
        if (modeLabel) {
          modeLabel.textContent = toggleEl.checked
            ? "Onlayn kurslar"
            : "Demo kurslar";
        }
        recalc();
      });

      directionEl.addEventListener("change", recalc);
      amountEl.addEventListener("input", recalc);

      calcBtn.addEventListener("click", async () => {
        const oldText = calcBtn.textContent;
        calcBtn.classList.add("btn-loading");
        calcBtn.textContent = "Hisoblanmoqda...";
        await recalc();
        setTimeout(() => {
          calcBtn.classList.remove("btn-loading");
          calcBtn.textContent = oldText;
        }, 400);
      });

      updateBaseRateLabel("UZS_KZT", DEMO_RATES["UZS_KZT"], "demo");
      recalc();
    }

    // ==== SEND MONEY HOLD-TO-SEND ====
    function setupSendMoney() {
      const btn = document.getElementById("sendHoldBtn");
      const amtEl = document.getElementById("sendAmount");
      const curEl = document.getElementById("sendCurrency");
      const noteEl = document.getElementById("sendNote");
      const statusEl = document.getElementById("sendStatus");

      if (!btn || !amtEl || !curEl || !noteEl || !statusEl) return;

      let holdTimer = null;
      let isHolding = false;

      function resetStatus() {
        statusEl.classList.remove("err");
        statusEl.textContent = "Demo: to‘lov yuborishga tayyor ✅";
      }

      function startHold() {
        if (isHolding) return;
        isHolding = true;
        btn.classList.add("btn-loading");
        btn.textContent = "Ushlab turilmoqda...";

        holdTimer = setTimeout(() => {
          const rawAmt = amtEl.value.trim();
          const amt = parseFloat(rawAmt.replace(",", "."));
          const cur = curEl.value;
          const note = noteEl.value.trim();

          if (!rawAmt || isNaN(amt) || amt <= 0) {
            statusEl.classList.add("err");
            statusEl.textContent =
              "Miqdor kiritilmadi. Demo: to‘lov bekor qilindi.";
          } else {
            statusEl.classList.remove("err");
            const notePart = note ? ` · Izoh: “${note}”` : "";
            statusEl.textContent =
              `Demo: ${fmt(amt)} ${cur} yuborildi ✅${notePart}`;
          }

          btn.classList.remove("btn-loading");
          btn.textContent = "Yuborish uchun ushlab turing";
          isHolding = false;
        }, 900);
      }

      function cancelHold() {
        if (!isHolding) return;
        clearTimeout(holdTimer);
        btn.classList.remove("btn-loading");
        btn.textContent = "Yuborish uchun ushlab turing";
        isHolding = false;
        resetStatus();
      }

      btn.addEventListener("mousedown", startHold);
      btn.addEventListener("touchstart", startHold);
      btn.addEventListener("mouseup", cancelHold);
      btn.addEventListener("mouseleave", cancelHold);
      btn.addEventListener("touchend", cancelHold);
      btn.addEventListener("touchcancel", cancelHold);

      resetStatus();
    }

    // ==== CHEGARASIZ TO'LOVLAR DEMO ====
    function setupBorderless() {
      const btn = document.getElementById("borderlessBtn");
      const statusEl = document.getElementById("borderlessStatus");
      const fromEl = document.getElementById("b_fromCountry");
      const toEl = document.getElementById("b_toService");
      const accEl = document.getElementById("b_account");
      const amtEl = document.getElementById("b_amount");
      const curEl = document.getElementById("b_currency");

      if (!btn || !statusEl || !fromEl || !toEl || !accEl || !amtEl || !curEl) return;

      btn.addEventListener("click", () => {
        const rawAmt = amtEl.value.trim();
        const amt = parseFloat(rawAmt.replace(",", "."));
        const acc = accEl.value.trim();

        if (!rawAmt || isNaN(amt) || amt <= 0 || !acc) {
          statusEl.classList.add("err");
          statusEl.textContent =
            "Summani va hisob raqamni to‘ldiring (demo).";
          return;
        }

        statusEl.classList.remove("err");

        // oddiy: 1% konvertatsiya + 1% komissiya
        const totalFeePercent = 0.02;
        const feeAmt = amt * totalFeePercent;
        const final = amt + feeAmt;

        statusEl.textContent =
          `Demo: ~${fmt(final)} UZS ekv. bilan ` +
          `${curEl.value}da to‘lov yuboriladi (2% umumiy komissiya).`;
      });
    }
// ==== PROFILE MODAL & TELEGRAM USER ====
    function initProfileSheet() {
      const bg = document.getElementById("profileBg");
      const openBtn = document.getElementById("profileOpen");
      const closeBtn = document.getElementById("profileClose");
      const pfName = document.getElementById("pf_name");
      const pfId = document.getElementById("pf_id");
      const pfUsername = document.getElementById("pf_username");

      if (!bg || !openBtn || !closeBtn) return;

      function open() {
        bg.classList.add("active");
      }
      function close() {
        bg.classList.remove("active");
      }

      openBtn.addEventListener("click", open);
      closeBtn.addEventListener("click", close);
      bg.addEventListener("click", (e) => {
        if (e.target === bg) close();
      });

      // 1) URL parametrlaridan o‘qish
      const params = new URLSearchParams(window.location.search);
      let tgId = params.get("tg_id");
      let tgName = params.get("tg_name");
      let tgUsername = params.get("tg_username");

      // 2) Agar bo‘sh bo‘lsa, Telegram WebApp.initDataUnsafe dan olish
      try {
        if (
          (!tgId || !tgName) &&
          window.Telegram &&
          Telegram.WebApp &&
          Telegram.WebApp.initDataUnsafe &&
          Telegram.WebApp.initDataUnsafe.user
        ) {
          const u = Telegram.WebApp.initDataUnsafe.user;
          if (!tgId && u.id) tgId = String(u.id);
          if (!tgName) {
            const full = [u.first_name, u.last_name].filter(Boolean).join(" ");
            tgName = full || "";
          }
          if (!tgUsername && u.username) tgUsername = u.username;
        }
      } catch (e) {
        console.log("Telegram user data error:", e);
      }

      pfName.textContent = tgName || "-";
      pfId.textContent = tgId || "-";
      pfUsername.textContent = tgUsername ? "@" + tgUsername : "-";

      try {
        if (window.Telegram && Telegram.WebApp) {
          Telegram.WebApp.ready();
          Telegram.WebApp.expand();
        }
      } catch (e) {
        console.log("Telegram ready error:", e);
      }
    }

    window.addEventListener("load", () => {
      setupTabs();
      setupBalanceToggle();
      setupCalcUI();
      setupSendMoney();
      setupBorderless();
      initProfileSheet();
    });
  </script>
</body>
</html>
